From 7d9acf37a1168711ffa4458e33c7bc99a5b2c543 Mon Sep 17 00:00:00 2001
From: Brian Lin <brianhlin@gmail.com>
Date: Thu, 4 Feb 2021 12:18:57 -0600
Subject: [PATCH] Drop Python-based remote OS/distro detection (HTCONDOR-242)

---
 src/condor_contrib/bosco/bosco_cluster | 70 +++++++++++++++++---------
 1 file changed, 45 insertions(+), 25 deletions(-)

diff --git a/src/condor_contrib/bosco/bosco_cluster b/src/condor_contrib/bosco/bosco_cluster
index ebcb582ab4..fca8e69568 100755
--- /usr/bin/bosco_cluster
+++ /usr/bin/bosco_cluster
@@ -253,32 +253,51 @@ ssh_find_remote () {
     # Find the platform of the remote host
     # 1. remote host
     remote_host=$1
-    cmd_out=`ssh $remote_host "python3 -c \"import sys; import platform; mydist = platform.dist(); print('%s %s%s' % (sys.platform, mydist[0], mydist[1]))\"" 2>/dev/null`
-    if [ $? -eq 0 ]; then
-        # check for linux
-        case "$cmd_out" in 
-            (*redhat7* | *centos7*)
-                echo "CentOS7" ;;
-            (*redhat8* | *centos8*)
-                echo "CentOS8" ;;
-            (*debian9*)
-                echo "Debian9" ;;
-            (*debian10*)
-                echo "Debian10" ;;
-            (*Ubuntu16*)
-                echo "Ubuntu16" ;;
-            (*Ubuntu18*)
-                echo "Ubuntu18" ;;
-            (*Ubuntu20*)
-                echo "Ubuntu20" ;;
-            (*darwin*)
-                echo "MacOSX" ;;
-            (*) ;;
-        esac
-        return 0
-    fi
-    return 1
+
+    # Returns 'Darwin' for Mac OS X or 'Linux'
+    detect_os=`ssh $remote_host "uname -s"`
+    [[ $? -eq 0 ]] || return 1
+
+    case "$detect_os" in
+        Linux)
+            ssh_detect_linux_distro "$remote_host"
+            return $?
+            ;;
+        Darwin)
+            echo "MacOSX"
+            return 0
+            ;;
+        *)
+            return 1
+            ;;
+    esac
+}
+
+
+ssh_detect_linux_distro () {
+    # Find the linux distro of the remote host
+    # 1. remote host
+    remote_host=$1
+
+    os_release=`ssh $remote_host "cat /etc/os-release" 2> /dev/null`
+    [[ $? -eq 0 ]] || return 1
+
+    dist=`awk -F '=' '/^ID=/ {print $2}' <<< $os_release | tr -d '"'`
+    ver=`awk -F '=' '/^VERSION_ID=/ {print $2}' <<< $os_release | tr -d '"'`
+    major_ver="${ver%%.*}"
+
+    case "$dist" in
+        (rhel|centos)
+            echo "CentOS${major_ver}" ;;
+        debian)
+            echo "Debian${major_ver}" ;;
+        ubuntu)
+            echo "Ubuntu${major_ver}" ;;
+        (*)
+            return 1
+            ;;
+    esac
+    return 0
 }
 
 
-- 
2.25.4

